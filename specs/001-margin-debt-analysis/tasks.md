# 任务分解: 融资余额市场分析系统

**功能名称**: 融资余额市场分析系统
**版本**: 1.0.0
**分支**: 001-margin-debt-analysis
**创建日期**: 2025-11-12
**基于**: /speckit.tasks 命令输出

**概述**:
构建基于Streamlit的Web应用，通过7个核心指标图表（包括脆弱性指数）和4个历史危机时期对比，实现市场风险信号识别和投资机会分析。系统支持1997-2025年数据，Part1指标（1997-01开始），Part2指标（2010-02开始）。

---

## Phase 1: 项目初始化

### 故事目标
建立完整的开发环境、虚拟环境和项目结构，确保所有依赖正确安装并可正常运行。

### 独立测试标准
- [ ] 虚拟环境创建成功，Python 3.11+版本验证
- [ ] 所有依赖（Streamlit, Pandas, Plotly, yfinance, fredapi）安装完成
- [ ] 项目目录结构创建并验证（src/, datas/, docs/, tests/）
- [ ] config.py配置文件创建并包含基本设置
- [ ] requirements.txt文件创建并锁定版本

### 实施任务

- [ ] T001 创建项目根目录结构和虚拟环境
- [ ] T002 创建requirements.txt文件并安装所有依赖
- [ ] T003 创建src/目录结构和所有子模块目录
- [ ] T004 创建datas/目录和docs/目录结构
- [ ] T005 创建tests/目录结构
- [ ] T006 创建config.py配置文件，包含数据源、脆弱性指数和可视化配置
- [ ] T007 验证Streamlit应用可以正常启动（显示基础页面）

---

## Phase 2: 基础设施与数据获取

### 故事目标
建立数据获取、处理和存储的完整基础设施，确保能够从多数据源（FRED、Yahoo Finance、CBOE、FINRA）获取数据并进行初步处理。

### 独立测试标准
- [ ] 能够成功加载FINRA本地数据文件（margin-statistics.csv）
- [ ] 能够从FRED获取M2、利率数据
- [ ] 能够从Yahoo Finance获取S&P500、VIX数据
- [ ] 数据对齐和合并功能正常
- [ ] 数据缓存机制工作正常
- [ ] 数据质量检查通过（无异常缺失值）

### 实施任务

- [ ] T008 实现data_fetcher.py模块中的load_finra_data()函数
- [ ] T009 实现data_fetcher.py模块中的fetch_vix_data()函数
- [ ] T010 实现data_fetcher.py模块中的fetch_market_cap_data()函数
- [ ] T011 实现data_fetcher.py模块中的fetch_fred_data()函数
- [ ] T012 [P] 实现data_fetcher.py模块中的sync_data_sources()函数进行数据对齐
- [ ] T013 创建数据处理模块processor.py，处理数据清洗和合并
- [ ] T014 实现数据缓存机制，避免重复API调用
- [ ] T015 编写单元测试：test_data_fetcher.py
- [ ] T016 集成测试：验证完整数据获取流程（从多个源到合并数据）

---

## Phase 3: 计算引擎开发（核心算法）

### 故事目标
实现Part1和Part2所有计算指标，特别是脆弱性指数算法（Vulnerability = Leverage_Z - VIX_Z），确保计算准确性和性能。

### 独立测试标准
- [ ] 杠杆净值计算（Leverage_Net = D - (CC + CM)）正确
- [ ] 杠杆Z分数和VIX Z分数计算正确（252天滚动窗口）
- [ ] 脆弱性指数计算结果符合预期（>3高风险，<-3低风险）
- [ ] 所有Part1指标（市场杠杆率、货币供应比率、利率成本分析）计算正确
- [ ] 所有Part2指标（杠杆变化率、投资者净资产、杠杆标准化）计算正确
- [ ] 计算性能满足要求：<10秒完成全部指标计算

### 实施任务

- [ ] T017 实现margin_debt_calculator.py模块
- [ ] T018 [P] 实现vulnerability_index.py模块，包含calculate_zscore()核心函数
- [ ] T019 [P] 实现vulnerability_index.py模块中的calculate_leverage_zscore()和calculate_vix_zscore()
- [ ] T020 实现脆弱性指数计算函数calculate_vulnerability_index()
- [ ] T021 实现risk_analyzer.py模块中的classify_risk_level()函数
- [ ] T022 实现所有Part1指标计算：market_leverage_ratio, money_supply_ratio, interest_cost_analysis
- [ ] T023 实现所有Part2指标计算：leverage_change_mom/yoy, investor_net_worth, leverage_normalized
- [ ] T024 实现Z-Score计算的验证函数validate_vulnerability_calculation()
- [ ] T025 编写单元测试：test_indicators.py和test_vulnerability_index.py
- [ ] T026 创建历史数据回测验证脚本，验证脆弱性指数算法准确性

---

## Phase 4: 可视化系统开发

### 故事目标
实现7个核心指标的可视化图表，包括新增的VIX与杠杆对比图表，确保图表交互性和性能。

### 独立测试标准
- [ ] 7个核心图表全部正常渲染（市场杠杆率、货币供应比率、利率成本、杠杆变化、投资者净资产、脆弱性指数、VIX与杠杆对比）
- [ ] 图表交互正常（缩放、平移、悬停显示）
- [ ] 双Y轴图表（VIX与杠杆）正确显示
- [ ] 历史危机时期标记功能正常（4个时期）
- [ ] 图表加载时间 < 2秒
- [ ] 所有图表支持时间范围筛选

### 实施任务

- [ ] T027 [P] 实现visualization.py中的create_market_leverage_chart()函数
- [ ] T028 [P] 实现visualization.py中的create_money_supply_chart()函数
- [ ] T029 [P] 实现visualization.py中的create_interest_cost_chart()函数
- [ ] T030 [P] 实现visualization.py中的create_leverage_change_chart()函数
- [ ] T031 [P] 实现visualization.py中的create_investor_net_worth_chart()函数
- [ ] T032 [P] 实现visualization.py中的create_vulnerability_index_chart()函数（核心图表）
- [ ] T033 实现visualization.py中的create_vix_leverage_chart()函数（新增图表，双Y轴）
- [ ] T034 实现highlight_historical_crises()函数，标记4个历史危机时期
- [ ] T035 实现图表优化：使用plotly.graph_objects优化渲染性能
- [ ] T036 编写单元测试：test_visualization.py

---

## Phase 5: [US1] 核心杠杆指标仪表板（P1）

### 故事目标
实现主要用户故事：展示7个核心指标的综合仪表板，用户可以立即查看当前市场杠杆水平和脆弱性指数。

### 独立测试标准
- [ ] 用户打开首页后30秒内看到所有7个核心指标可视化
- [ ] 脆弱性指数图表突出显示，占据主要区域
- [ ] 当前风险等级清晰标识（低/中/高/极高）
- [ ] 数据来源标注和时间范围显示
- [ ] 鼠标悬停显示详细数据（数值、Z分数、历史百分位）
- [ ] 无需额外操作即可获得核心价值

### 实施任务

- [ ] T037 创建app.py主应用入口文件
- [ ] T038 实现Streamlit页面配置（宽屏布局、页面标题、侧边栏）
- [ ] T039 实现数据加载和缓存（@st.cache_data）
- [ ] T040 [P] 实现7个核心图表的渲染逻辑
- [ ] T041 实现脆弱性指数图表的重点展示（核心区域）
- [ ] T042 实现风险等级的颜色编码系统（绿色-低、黄色-中、橙色-高、红色-极高）
- [ ] T043 实现时间范围选择器（滑块 + 预设按钮）
- [ ] T044 实现图表悬停信息和数据标注
- [ ] T045 集成测试：验证US1所有验收场景

---

## Phase 6: [US2] 历史危机时期对比分析（P2）

### 故事目标
实现历史危机时期对比功能，用户可以选择并对比不同历史危机时期的市场表现，识别危机前的预警信号。

### 独立测试标准
- [ ] 用户可以选择3个预设历史危机时期：互联网泡沫(2000-2002)、金融危机(2007-2009)、疫情冲击(2020-2022)
- [ ] 所有7个指标图表显示选中时期的数据高亮（阴影区域）
- [ ] 与当前值的差异百分比正确显示
- [ ] 支持多时期同时对比（不同颜色标识）
- [ ] 响应时间 < 2秒

### 实施任务

- [ ] T046 [P] 实现历史危机时期数据模块historical_crises.py
- [ ] T047 [P] 实现危机时期标记的交互选择功能（复选框）
- [ ] T048 实现图表上的垂直阴影高亮标记（add_vrect）
- [ ] T049 实现多时期对比的颜色系统和图例
- [ ] T050 实现危机时期详细信息面板（显示特征、持续时间、影响）
- [ ] T051 实现当前值与历史危机时期的对比计算
- [ ] T052 集成测试：验证US2所有验收场景

---

## Phase 7: [US3] 交互式数据筛选与投资洞察（P3）

### 故事目标
实现交互式筛选和投资洞察功能，用户可以自定义时间范围，获得基于量化分析的市场风险信号和投资建议。

### 独立测试标准
- [ ] 用户可以设置自定义时间范围，所有图表即时更新
- [ ] 交互式可视化完全响应（<2秒）
- [ ] 投资洞察面板显示风险等级、市场状态评估、投资建议
- [ ] 基于脆弱性指数的投资建议置信度 > 80%
- [ ] 所有分析结果页面显著显示免责声明

### 实施任务

- [ ] T053 实现交互式时间范围选择器（动态更新所有图表）
- [ ] T054 [P] 实现投资洞察面板生成函数generate_investment_insights()
- [ ] T055 [P] 实现风险信号识别函数detect_bubble_signals()
- [ ] T056 实现市场状态分类函数classify_market_regime()
- [ ] T057 实现投资建议生成逻辑（基于量化模型和置信度阈值）
- [ ] T058 实现数据导出功能（CSV、Excel、JSON）
- [ ] T059 实现实时数据更新机制（可选，每60秒刷新）
- [ ] T060 实现免责声明显示（所有分析结果页面）
- [ ] T061 集成测试：验证US3所有验收场景

---

## Phase 8: 系统集成与优化

### 故事目标
完成系统集成，进行性能优化、数据质量检查和端到端测试，确保系统满足性能目标和质量要求。

### 独立测试标准
- [ ] 页面加载时间 < 30秒
- [ ] 图表交互响应时间 < 2秒
- [ ] 单次数据更新 < 10秒
- [ ] 数据覆盖率 Part1 ≥95%，Part2 ≥95%
- [ ] 核心算法测试覆盖率 > 80%
- [ ] 所有15个功能需求（FR-001至FR-015）验证通过

### 实施任务

- [ ] T062 实现端到端集成测试：test_integration.py
- [ ] T063 性能优化：启用Streamlit缓存，优化大数据集加载
- [ ] T064 数据质量检查：验证所有约束（缺失值、异常值、逻辑一致性）
- [ ] T065 实现数据版本管理和变更日志
- [ ] T066 实施监控指标：数据刷新状态、API响应时间、成功率
- [ ] T067 性能压力测试：模拟大数据量、高并发访问
- [ ] T068 错误处理：实现API失败降级机制、数据缺失处理
- [ ] T069 安全审查：检查数据源认证、API密钥管理

---

## Phase 9: 文档与交付

### 故事目标
完善项目文档、快速开始指南和用户手册，确保用户可以顺利安装、配置和使用系统。

### 独立测试标准
- [ ] 快速开始指南（quickstart.md）验证通过
- [ ] API文档完整（contracts/ + 实际实现对齐）
- [ ] 用户手册包含所有功能说明和截图
- [ ] 故障排除指南覆盖所有常见问题
- [ ] 开发文档包含代码结构和开发规范

### 实施任务

- [ ] T070 更新quickstart.md：验证所有步骤可执行
- [ ] T071 创建用户手册：包含所有功能的详细说明和截图
- [ ] T072 更新API文档：确保contracts/与实际实现一致
- [ ] T073 创建部署指南：Linux服务器部署、nginx配置
- [ ] T074 创建故障排除指南：常见问题和解决方案
- [ ] T075 创建开发文档：代码结构、开发规范、贡献指南
- [ ] T076 生成项目README.md文件

---

## Phase 10: 最终测试与验收

### 故事目标
执行完整的用户验收测试，验证所有用户故事和验收场景通过，确保系统满足所有成功标准。

### 独立测试标准
- [ ] US1验收场景全部通过（查看核心指标仪表板）
- [ ] US2验收场景全部通过（历史危机时期对比）
- [ ] US3验收场景全部通过（交互式筛选与投资洞察）
- [ ] 所有成功标准（SC-001至SC-009）验证通过
- [ ] 手动测试检查清单（25项）全部通过
- [ ] 免责声明显著显示并符合要求

### 实施任务

- [ ] T077 执行US1完整验收测试：用户打开系统30秒内看到所有7个指标
- [ ] T078 执行US2完整验收测试：历史危机时期选择、对比、高亮显示
- [ ] T079 执行US3完整验收测试：时间范围筛选、投资洞察、风险信号
- [ ] T080 执行手动测试检查清单：25项功能验证
- [ ] T081 验证性能指标：页面加载、图表交互、数据更新
- [ ] T082 验证数据质量：覆盖率、一致性、完整性
- [ ] T083 最终系统测试：启动、运行、数据导出、错误处理
- [ ] T084 文档验证：快速开始指南、用户手册、故障排除
- [ ] T085 生成测试报告和验收报告

---

## 依赖关系

### 用户故事完成顺序
```
US1 (P1) → US2 (P2) → US3 (P3)
  ↓           ↓           ↓
核心仪表板   危机对比    交互筛选
(必需)       (增强)     (增值)
```

### 阻塞依赖图
```
Phase 1 (环境) → Phase 2 (数据获取) → Phase 3 (计算引擎) → Phase 4 (可视化) → US1 (仪表板)
                                                                        → US2 (危机对比)
                                                                        → US3 (交互筛选)
```

### 并行执行机会
- **T008-T011**: 多个数据源获取函数（data_fetcher.py的不同方法）
- **T017-T023**: 计算模块的不同函数实现
- **T027-T033**: 7个可视化图表函数（除T034危机标记外）
- **T040**: 7个图表渲染逻辑（独立实现）
- **T046-T047**: 危机时期选择和高亮标记（不同模块）
- **T053-T055**: 投资洞察和风险信号（不同功能模块）

---

## 并行执行示例

### 示例1: 独立模块并行开发
```bash
# 可以并行执行的独立任务
并行组1 (数据获取):
  T008 load_finra_data()      # 本地文件，无需外部API
  T009 fetch_vix_data()       # Yahoo Finance，独立数据源
  T010 fetch_market_cap_data() # FRED，独立数据源

并行组2 (计算函数):
  T017 margin_debt_calculator # 基础指标计算
  T018 vulnerability_index    # Z分数计算（独立算法）
  T021 classify_risk_level    # 风险分类（独立函数）

并行组3 (可视化图表):
  T027-T033 7个图表函数      # 每个图表独立实现
```

### 示例2: 用户故事并行开发
```
US1 (P1) 必须在 Phase 4完成后开始
US2 (P2) 可以在 US1完成后并行开发（共享相同基础模块）
US3 (P3) 可以在 US1完成后并行开发（利用已实现的基础功能）
```

### 示例3: 依赖最小化的任务分组
```
组A (数据基础设施):
  - T008-T012: 数据获取和同步
  - 阻塞: 无（除T001-T006）

组B (计算引擎):
  - T017-T026: 指标计算和测试
  - 阻塞: 组A完成（T012数据同步）

组C (可视化核心):
  - T027-T036: 7个图表和危机标记
  - 阻塞: 组B完成（T017-T023计算函数）

组D (用户故事US1):
  - T037-T045: 主仪表板实现
  - 阻塞: 组C完成（T027-T033图表）
```

---

## 实施策略

### MVP范围 (Phase 3-4 完成时)
**最小可行产品**:
- ✅ 基础数据获取和处理
- ✅ 核心计算引擎（脆弱性指数）
- ✅ 7个核心指标图表
- ✅ 基础仪表板（US1完整功能）
- ✅ 时间范围选择
- ✅ 风险等级显示

**不在MVP范围**:
- ❌ 历史危机时期对比（US2）
- ❌ 交互式投资洞察（US3）
- ❌ 数据导出功能
- ❌ 实时数据更新

### 增量交付计划

**第1次交付 (MVP)**:
- Phase 1-4 + US1 (P1) 完整功能
- 用户可以看到核心价值：7个指标仪表板 + 脆弱性指数
- 预计时间: 5-7天

**第2次交付**:
- Phase 5 (US2) 历史危机时期对比
- 增强用户体验：历史对比分析
- 预计时间: 2-3天

**第3次交付**:
- Phase 6 (US3) 交互式筛选和投资洞察
- 完整功能：所有用户故事完成
- 预计时间: 2-3天

**第4次交付**:
- Phase 7-8 系统优化和测试
- 生产就绪：性能、质量、文档
- 预计时间: 2-3天

### 风险缓解策略

**技术风险**:
- API限制：实施缓存机制，错误重试
- 性能问题：分块加载，优化图表渲染
- 数据质量问题：多源验证，质量检查

**进度风险**:
- 关键路径：数据获取 → 计算引擎 → 可视化 → 仪表板
- 缓冲时间：每阶段预留20%缓冲
- 并行执行：识别独立任务，最大化并行

**质量风险**:
- 测试驱动：每个模块都有对应测试
- 集成测试：关键流程端到端验证
- 用户验收：每阶段都有验收标准

---

## 任务统计

### 总览
- **总任务数**: 85个任务 (T001-T085)
- **可并行任务**: 约35个任务（标记[P]）
- **必需顺序任务**: 约50个任务（具有明确依赖）

### 按阶段分布
- Phase 1: 7个任务（项目初始化）
- Phase 2: 9个任务（数据获取）
- Phase 3: 10个任务（计算引擎）
- Phase 4: 10个任务（可视化）
- Phase 5: 9个任务（US1核心仪表板）
- Phase 6: 7个任务（US2危机对比）
- Phase 7: 9个任务（US3交互筛选）
- Phase 8: 8个任务（集成优化）
- Phase 9: 7个任务（文档交付）
- Phase 9个任务（最终测试）

### 按用户故事分布
- **US1 (P1)**: 9个任务（核心仪表板）
- **US2 (P2)**: 7个任务（危机对比）
- **US3 (P3)**: 9个任务（交互筛选）
- **共享模块**: 60个任务（基础设施、计算、可视化）

### 并行机会
- **Phase 2**: 4个并行任务（T008-T012）
- **Phase 3**: 3个并行任务（T017-T021）
- **Phase 4**: 7个并行任务（T027-T033）
- **Phase 5**: 1个并行任务（T040）
- **Phase 6**: 2个并行任务（T046-T047）
- **Phase 7**: 3个并行任务（T053-T055）

---

## 质量检查点

### 代码质量
- [ ] 所有模块都有对应单元测试
- [ ] 测试覆盖率 > 80%（核心算法）
- [ ] 关键函数都有文档字符串
- [ ] 遵循PEP 8代码规范
- [ ] 类型提示覆盖所有函数签名

### 数据质量
- [ ] 数据覆盖率验证（Part1 ≥95%, Part2 ≥95%）
- [ ] 逻辑一致性检查通过
- [ ] 跨数据源验证通过
- [ ] 异常值检测和处理
- [ ] 脆弱性指数算法验证通过

### 性能质量
- [ ] 页面加载时间 < 30秒
- [ ] 图表交互时间 < 2秒
- [ ] 数据更新时间 < 10秒
- [ ] 内存使用 < 2GB
- [ ] API调用成功率 > 95%

### 用户体验
- [ ] 首次访问30秒内看到所有核心指标
- [ ] 图表缩放、平移、悬停正常
- [ ] 时间范围选择器响应 < 2秒
- [ ] 历史危机时期高亮正确
- [ ] 免责声明显著显示

---

## 最终验证

### 成功标准确认
- ✅ SC-001: 用户30秒内看到7个核心指标（US1验收）
- ✅ SC-002: 数据覆盖率验证（数据质量检查）
- ✅ SC-003: 交互式图表响应时间（性能测试）
- ✅ SC-004: 脆弱性指数清晰展示（可视化验收）
- ✅ SC-005: 数据源集成成功率（API监控）
- ✅ SC-006: 投资洞察置信度 > 80%（US3验收）
- ✅ SC-007: 历史危机时期对比（US2验收）
- ✅ SC-008: 时间范围筛选 < 5秒（性能测试）
- ✅ SC-009: 免责声明显示（UI检查）

### 交付清单
- [ ] 完整的Streamlit Web应用（app.py）
- [ ] 85个任务全部完成
- [ ] 所有测试通过（单元测试、集成测试、验收测试）
- [ ] 性能基准达标
- [ ] 文档完整（快速开始、用户手册、API文档）
- [ ] 项目结构符合plan.md设计
- [ ] 7个核心图表全部实现并验证
- [ ] 脆弱性指数算法验证通过
- [ ] 3个用户故事全部实现
- [ ] 免责声明符合要求

---

**任务分解完成日期**: 2025-11-12
**预计开发周期**: 12-16天（并行执行）
**关键路径**: 数据获取 → 计算引擎 → 可视化 → 核心仪表板
**风险等级**: 中等（有缓冲和并行执行机会）

**下一步行动**:
1. 开始Phase 1任务（T001-T007）
2. 设置开发环境和项目结构
3. 验证所有依赖安装正确
4. 准备开始Phase 2数据获取开发