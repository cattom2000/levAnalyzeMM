# -*- coding: utf-8 -*-
"""
脆弱性指数核心算法模块合同
Vulnerability Index Core Algorithm Module Contract

**最核心指标** - 市场风险信号的综合体现
计算脆弱性指数 (杠杆Z分数 - VIX Z分数)，反映市场杠杆水平与恐慌情绪的差值。

**Core Indicator** - Comprehensive market risk signal
Calculates Vulnerability Index (Leverage Z-Score - VIX Z-Score), reflecting the
difference between market leverage level and panic sentiment.

算法设计参考: docs/sig_Bubbles.md

版本: 1.0.0
日期: 2025-11-08
"""

from typing import Dict, List, Optional, Tuple, Union
import pandas as pd
import numpy as np


class VulnerabilityIndex:
    """
    脆弱性指数计算器
    Vulnerability Index Calculator

    **核心算法**: 杠杆Z分数 - VIX Z分数
    解释逻辑:
    - 高脆弱性: 高杠杆Z分数 + 低VIX Z分数 = 市场自满但杠杆高
    - 低脆弱性: 低杠杆Z分数 + 高VIX Z分数 = 市场谨慎但杠杆低
    """

    def __init__(self) -> None:
        """初始化计算器"""
        pass

    # ==================== 核心Z分数计算 ====================

    def calculate_zscore(
        self,
        series: pd.Series,
        window: int = 252,
        min_periods: Optional[int] = None,
        method: str = "rolling"
    ) -> pd.Series:
        """
        计算滚动Z分数 (标准差标准化)

        Z = (X - μ) / σ
        其中 μ 为滚动均值，σ 为滚动标准差

        Args:
            series: 原始数据 Series
            window: 滚动窗口 (默认252个交易日≈12个月)
            min_periods: 最小观测数，默认 window//2
            method: 计算方法 ('rolling', 'expanding', 'ewm')

        Returns:
            Z分数 Series (标准化值，可正可负)
            - 正值: 高于历史平均水平
            - 负值: 低于历史平均水平
            - 绝对值 > 2: 异常值

        Example:
            >>> data = pd.Series([1, 2, 3, 4, 5] * 50)  # 模拟250个数据点
            >>> zscore = vix_calc.calculate_zscore(data, window=20)
            >>> print(zscore.dropna().iloc[0])  # 前20个数据的Z分数
            0.0
        """
        raise NotImplementedError

    def calculate_leverage_zscore(
        self,
        margin_debt: pd.Series,
        sp500_market_cap: pd.Series,
        window: int = 252
    ) -> pd.Series:
        """
        计算杠杆Z分数

        杠杆率 = Margin Debt / S&P 500 Market Cap
        然后对杠杆率计算Z分数

        Args:
            margin_debt: 融资余额 Series (万亿美元)
            sp500_market_cap: S&P500总市值 Series (万亿美元)
            window: 滚动窗口 (默认252个交易日)

        Returns:
            杠杆Z分数 Series

        Example:
            >>> margin = pd.Series([0.8, 0.85, 0.9] * 84)  # 252个月度数据
            >>> market_cap = pd.Series([40, 42, 45] * 84)
            >>> leverage_z = vix_calc.calculate_leverage_zscore(margin, market_cap)
        """
        raise NotImplementedError

    def calculate_vix_zscore(
        self,
        vix_index: pd.Series,
        window: int = 252
    ) -> pd.Series:
        """
        计算VIX Z分数

        直接对VIX指数计算Z分数

        Args:
            vix_index: VIX指数 Series
            window: 滚动窗口 (默认252个交易日)

        Returns:
            VIX Z分数 Series

        Example:
            >>> vix = pd.Series([20, 25, 30, 35] * 63)  # 252个数据点
            >>> vix_z = vix_calc.calculate_vix_zscore(vix)
        """
        raise NotImplementedError

    # ==================== 脆弱性指数计算 ====================

    def calculate_vulnerability_index(
        self,
        leverage_zscore: pd.Series,
        vix_zscore: pd.Series,
        date_index: Optional[pd.DatetimeIndex] = None
    ) -> pd.Series:
        """
        **核心算法** - 计算脆弱性指数

        公式: Vulnerability Index = Leverage Z-Score - VIX Z-Score

        解释逻辑:
        - 高脆弱性 (> 1.0): 杠杆高但VIX低 = 市场自满，高风险
        - 中等脆弱性 (0-1.0): 杠杆与VIX相对平衡
        - 低脆弱性 (0到-1.0): 杠杆低或VIX高 = 市场谨慎
        - 极低脆弱性 (< -1.0): 市场极度恐慌但杠杆低

        Args:
            leverage_zscore: 杠杆Z分数 Series
            vix_zscore: VIX Z分数 Series
            date_index: 日期索引 (可选)

        Returns:
            脆弱性指数 Series
            - 范围: 通常 -3 到 +3
            - > 2.0: 极高风险
            - 1.0-2.0: 高风险
            - 0.0-1.0: 中等风险
            - -1.0-0.0: 低风险
            - < -1.0: 极低风险

        Example:
            >>> leverage_z = pd.Series([1.5, 1.2, 0.8, 0.5] * 63)  # 252个数据点
            >>> vix_z = pd.Series([-0.5, -0.2, 0.5, 1.0] * 63)
            >>> vuln_idx = vix_calc.calculate_vulnerability_index(leverage_z, vix_z)
            >>> print(vuln_idx.iloc[0])  # 1.5 - (-0.5) = 2.0 (极高风险)
            2.0
        """
        raise NotImplementedError

    def calculate_vulnerability_index_from_raw(
        self,
        margin_debt: pd.Series,
        sp500_market_cap: pd.Series,
        vix_index: pd.Series,
        window: int = 252
    ) -> pd.DataFrame:
        """
        从原始数据直接计算脆弱性指数

        一站式计算，包含中间步骤

        Args:
            margin_debt: 融资余额 Series
            sp500_market_cap: S&P500总市值 Series
            vix_index: VIX指数 Series
            window: 滚动窗口

        Returns:
            DataFrame包含:
            - date: 日期
            - leverage_ratio: 杠杆率
            - leverage_zscore: 杠杆Z分数
            - vix_zscore: VIX Z分数
            - vulnerability_index: **脆弱性指数** (主要输出)
        """
        raise NotImplementedError

    # ==================== 风险等级分类 ====================

    def classify_risk_level(
        self,
        vulnerability_index: pd.Series,
        method: str = "quartile"
    ) -> pd.Series:
        """
        根据脆弱性指数分类风险等级

        Args:
            vulnerability_index: 脆弱性指数 Series
            method: 分类方法 ('quartile', 'fixed', 'adaptive')

        Returns:
            风险等级 Series，值为 '低'/'中'/'高'/'极高'

        Quartile方法 (默认):
        - q0-q25: 低风险
        - q25-q50: 中风险
        - q50-q75: 高风险
        - q75-q100: 极高风险

        Fixed方法:
        - < 0: 低风险
        - 0-1: 中风险
        - 1-2: 高风险
        - > 2: 极高风险

        Example:
            >>> vuln_idx = pd.Series([2.0, 1.5, 0.5, -0.5, -1.5])
            >>> risk = vix_calc.classify_risk_level(vuln_idx)
            >>> print(list(risk))
            ['极高', '高', '中', '低', '低']
        """
        raise NotImplementedError

    def get_risk_statistics(
        self,
        vulnerability_index: pd.Series,
        risk_levels: pd.Series
    ) -> Dict[str, any]:
        """
        获取风险统计信息

        Args:
            vulnerability_index: 脆弱性指数 Series
            risk_levels: 风险等级 Series

        Returns:
            统计信息字典
            {
                'mean_vulnerability': float,
                'std_vulnerability': float,
                'max_vulnerability': float,
                'min_vulnerability': float,
                'risk_distribution': Dict[str, int],  # 各风险等级数量
                'current_risk_level': str,  # 最新风险等级
                'recent_trend': str,  # 'increasing', 'decreasing', 'stable'
                'alert_conditions': List[str]  # 触发预警的条件
            }
        """
        raise NotImplementedError

    # ==================== 历史回测与验证 ====================

    def validate_vulnerability_calculation(
        self,
        df: pd.DataFrame,
        expected_crises: List[Dict[str, str]]
    ) -> pd.DataFrame:
        """
        验证脆弱性指数计算的正确性

        检查历史危机前是否出现高脆弱性信号

        Args:
            df: 包含脆弱性指数的DataFrame
            expected_crises: 预期危机列表
                [
                    {'name': '2008金融危机', 'start': '2007-12-01', 'peak': '2008-09-15'},
                    {'name': '2020疫情', 'start': '2020-02-01', 'peak': '2020-03-23'}
                ]

        Returns:
            验证结果DataFrame，添加了以下列:
            - crisis_predicted: 是否成功预测
            - lead_time: 预警提前期 (月)
            - vulnerability_peak: 危机前脆弱性指数峰值
            - validation_score: 验证分数 (0-100)
        """
        raise NotImplementedError

    def backtest_vulnerability_signals(
        self,
        df: pd.DataFrame,
        threshold: float = 1.5,
        lookback_months: int = 12
    ) -> Dict[str, any]:
        """
        脆弱性指数信号回测

        Args:
            df: 包含脆弱性指数的DataFrame
            threshold: 预警阈值 (默认1.5)
            lookback_months: 回看月数 (默认12个月)

        Returns:
            回测结果字典
            {
                'total_signals': int,
                'true_positive': int,  # 正确预警
                'false_positive': int,  # 误报
                'missed_crisis': int,  # 漏报
                'precision': float,  # 精确率 = TP / (TP + FP)
                'recall': float,  # 召回率 = TP / (TP + FN)
                'f1_score': float,  # F1分数
                'average_lead_time': float  # 平均预警提前期
            }
        """
        raise NotImplementedError

    # ==================== 统计分析与可视化 ====================

    def calculate_historical_percentiles(
        self,
        vulnerability_index: pd.Series,
        percentiles: List[int] = [5, 10, 25, 50, 75, 90, 95]
    ) -> Dict[int, float]:
        """
        计算历史百分位

        Args:
            vulnerability_index: 脆弱性指数 Series
            percentiles: 要计算的百分位列表

        Returns:
            百分位字典 {percentile: value}

        Example:
            >>> vuln = pd.Series([...]  # 252个数据点
            >>> percentiles = vix_calc.calculate_historical_percentiles(vuln)
            >>> print(percentiles[95])  # 95%分位数
            1.82
        """
        raise NotImplementedError

    def detect_vulnerability_peaks(
        self,
        vulnerability_index: pd.Series,
        threshold: float,
        min_distance: int = 3
    ) -> pd.DataFrame:
        """
        检测脆弱性峰值

        Args:
            vulnerability_index: 脆弱性指数 Series
            threshold: 峰值阈值
            min_distance: 峰值间最小距离 (数据点数)

        Returns:
            峰值信息DataFrame
            - date: 峰值日期
            - value: 峰值数值
            - severity: 严重程度 ('moderate', 'high', 'extreme')
        """
        raise NotImplementedError

    def calculate_trend(
        self,
        vulnerability_index: pd.Series,
        window: int = 6
    ) -> pd.Series:
        """
        计算脆弱性指数趋势

        Args:
            vulnerability_index: 脆弱性指数 Series
            window: 趋势计算窗口 (月数)

        Returns:
            趋势 Series ('increasing', 'decreasing', 'stable')

        Example:
            >>> vuln = pd.Series([1.0, 1.2, 1.5, 1.3, 1.1])
            >>> trend = vix_calc.calculate_trend(vuln, window=3)
            >>> print(trend.iloc[-1])
            'decreasing'
        """
        raise NotImplementedError

    # ==================== 实时监控 ====================

    def check_alert_conditions(
        self,
        vulnerability_index: pd.Series,
        leverage_zscore: pd.Series,
        vix_zscore: pd.Series,
        alert_config: Optional[Dict] = None
    ) -> Dict[str, any]:
        """
        检查预警条件

        Args:
            vulnerability_index: 最新脆弱性指数
            leverage_zscore: 最新杠杆Z分数
            vix_zscore: 最新VIX Z分数
            alert_config: 预警配置 (可选)

        Returns:
            预警信息字典
            {
                'alert_level': str,  # 'info', 'warning', 'critical'
                'triggers': List[str],  # 触发的预警条件
                'recommendation': str,  # 建议操作
                'confidence': float,  # 预警置信度
                'details': Dict  # 详细信息
            }

        默认预警条件:
        1. 脆弱性指数 > 2.0: 极高风险
        2. 杠杆Z分数 > 1.5 且 VIX Z分数 < 0: 危险组合
        3. 脆弱性指数持续上升: 趋势预警
        """
        raise NotImplementedError

    # ==================== 数据导出 ====================

    def export_vulnerability_analysis(
        self,
        df: pd.DataFrame,
        output_path: str,
        include_visualization: bool = True
    ) -> bool:
        """
        导出脆弱性指数分析报告

        Args:
            df: 包含脆弱性指数的完整DataFrame
            output_path: 输出文件路径
            include_visualization: 是否包含可视化

        Returns:
            是否成功导出
        """
        raise NotImplementedError

    # ==================== 异常类定义 ====================

class InsufficientDataError(Exception):
    """数据不足错误 (需要至少252个数据点)"""
    pass


class CalculationError(Exception):
    """计算错误"""
    pass


class ValidationError(Exception):
    """验证错误"""
    pass


class AlertThresholdError(Exception):
    """预警阈值设置错误"""
    pass


# ==================== 合同版本信息 ====================

CONTRACT_VERSION = "1.0.0"
LAST_UPDATED = "2025-11-08"
ALGORITHM_REFERENCE = "docs/sig_Bubbles.md"
API_COMPATIBILITY = "Python 3.11+"

# ==================== 常量定义 ====================

DEFAULT_WINDOW = 252  # 默认滚动窗口 (交易日)
MIN_DATA_POINTS = 126  # 最小数据点要求 (一半窗口)
DEFAULT_THRESHOLD = 1.5  # 默认预警阈值
RISK_LEVELS = ['低', '中', '高', '极高']  # 风险等级列表
