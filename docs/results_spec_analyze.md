# 规范分析报告

**日期**: 2025-11-12
**分支**: 001-margin-debt-analysis
**分析命令**: /speckit.analyze

## 详细发现

| ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
|----|------|--------|------|------|------|
| **A1** | **不一致** | **CRITICAL** | spec.md:L81<br/>plan.md:L37<br/>tasks.md:L154 | **历史危机时期数量冲突**：<br/>- spec: "三个历史危机时期"<br/>- plan: "4个历史危机时期"<br/>- tasks: "3个预设历史危机时期" | 统一为4个时期并更新所有文档 |
| **A2** | **不一致** | **CRITICAL** | spec.md:L76<br/>plan.md:L207-210 | **市值数据源冲突**：<br/>- spec FR-003: "S&P 500指数和总市值: Yahoo Finance/FRED"<br/>- plan: "Wilshire 5000: FRED (用于杠杆标准化)" | 明确选择单一数据源（推荐Wilshire 5000） |
| **A3** | **不一致** | **CRITICAL** | plan.md:L92<br/>tasks.md:T008-T011 | **文件命名冲突**：<br/>- plan: src/data/fetcher.py<br/>- tasks: data_fetcher.py (始终一致) | 统一使用data_fetcher.py |
| **A4** | **章程违规** | **CRITICAL** | 章程:L85-91<br/>tasks.md | **持续监控机制缺失**：<br/>- 章程要求: 每日更新、每周报告、每月验证、每季度回顾<br/>- 任务中无对应实现任务 | 添加Phase 7任务实现监控机制 |
| **A5** | **重复需求** | **HIGH** | spec.md:L75-77 | **FR-002与FR-003部分重叠**：<br/>都提到S&P 500数据但指定不同数据源 | 合并为单一FR并明确数据源选择 |
| **A6** | **模糊性** | **HIGH** | spec.md:L79<br/>calMethod.md | **杠杆变化率定义不一致**：<br/>- spec: "Margin Debt年同比变化率YoY%"<br/>- calMethod: 基于"Leverage_Net = D - (CC + CM)" | 统一使用Leverage_Net作为基准 |
| **A7** | **未明确** | **HIGH** | spec.md:L76 | **死需求 - 黄金和BTC**：<br/>FR-003提到黄金和BTC价格，但文档中从未使用 | 删除或提供使用场景 |
| **A8** | **数字错误** | **MEDIUM** | tasks.md:L423-424 | **阶段编号重复**：<br/>"Phase 9: 文档与交付"和"Phase 9个任务" | 修正为Phase 9和Phase 10 |
| **A9** | **覆盖缺口** | **MEDIUM** | spec.md:L67-68 | **边缘案例任务覆盖不足**：<br/>多时期数据同步交互在任务中未明确覆盖 | 在US2任务中添加专门任务 |
| **A10** | **范围错误** | **MEDIUM** | spec.md:L78<br/>plan.md:L23 | **Part1指标计数错误**：<br/>spec说是3个，但"市场杠杆率、货币供应比率、利率成本分析"实际列出的是3个指标 | 计数正确，描述准确 |
| **A11** | **不一致** | **MEDIUM** | spec.md:L67<br/>FR-004 | **VIX可用性时间范围模糊**：<br/>边缘案例说"1990年之前不可用"，FR-004说"1990年至今" | 统一为"1990年至今" |
| **A12** | **未明确** | **LOW** | plan.md:L336-341 | **风险阈值硬编码**：<br/>plan中硬编码了具体阈值，但未说明是否可配置 | 在config.py中添加配置选项 |

## 覆盖率摘要表

| 需求键 | 有任务覆盖？ | 任务ID | 备注 |
|--------|-------------|--------|------|
| support-finra-data (FR-001) | ✅ | T008 | 完整覆盖 |
| support-fred-data (FR-002) | ✅ | T011 | 完整覆盖 |
| support-yahoo-data (FR-003) | ✅ | T009-T010 | 覆盖但有数据源冲突 |
| support-vix-data (FR-004) | ✅ | T009 | 完整覆盖 |
| part1-indicators (FR-005) | ✅ | T022 | 完整覆盖 |
| part2-indicators (FR-006) | ✅ | T023 | 完整覆盖 |
| multi-chart-display (FR-007) | ✅ | T027-T033 | 完整覆盖 |
| historical-crises (FR-008) | ✅ | T046-T052 | 完整覆盖但时期数量冲突 |
| interactive-visualization (FR-009) | ✅ | T037-T044 | 完整覆盖 |
| plotly-charts (FR-010) | ✅ | T027-T036 | 完整覆盖 |
| risk-signal-identification (FR-011) | ✅ | T055 | 完整覆盖 |
| investment-opportunities (FR-012) | ✅ | T054, T057 | 完整覆盖 |
| chart-labeling (FR-013) | ✅ | T027-T044 | 完整覆盖 |
| handle-missing-data (FR-014) | ✅ | T064, T068 | 完整覆盖 |
| disclaimer (FR-015) | ✅ | T060 | 完整覆盖 |
| **每日数据更新** (章程) | ❌ | - | **未覆盖** |
| **每周报告** (章程) | ❌ | - | **未覆盖** |
| **每月验证** (章程) | ❌ | - | **未覆盖** |
| ** Granger因果关系** (章程) | ❌ | - | **未覆盖** |

## 章程对齐问题

### ❌ 重大违规

1. **持续监控机制缺失** (章程第5条)
   - 问题：所有4项监控要求（每日更新、每周报告、每月验证、每季度回顾）均未在任务中体现
   - 影响：违反项目章程核心原则

2. **跨指标关联分析缺失** (章程第3条)
   - 问题：Granger因果关系检验在合同中未定义，在任务中无实现
   - 影响：无法满足量化分析要求

### ⚠️ 部分对齐

3. **风险检测阈值**
   - 状态：plan.md中的阈值与章程L56-63基本一致
   - 缺失：缺少实现任务

4. **数据源交叉验证**
   - 状态：已实现
   - 缺失：缺少统计分析验证（皮尔逊相关系数等）

## 未映射任务

**无未映射任务** - 所有85个任务均能映射到至少一个需求或用户故事。

## 指标统计

- **总需求数**: 15个FR (spec.md) + 5个章程原则 = 20个
- **总任务数**: 85个任务 (T001-T085)
- **覆盖率**: 75% (15/20个需求完全覆盖，5个章程需求未覆盖)
- **模糊性计数**: 4个 (历史时期数量、数据源选择、杠杆基准、死需求)
- **重复计数**: 1个 (FR-002/FR-003部分重叠)
- **关键问题计数**: 4个CRITICAL + 3个HIGH = 7个

## 结构性分析

### 一致性评分

- **spec.md ↔ plan.md**: 85% (主要冲突：危机时期、数据源)
- **plan.md ↔ tasks.md**: 90% (主要冲突：文件命名、监控机制)
- **spec.md ↔ tasks.md**: 88% (危机时期、边缘案例覆盖)

## 下一步行动

### 🔴 必须解决的关键问题 (CRITICAL)

1. **统一历史危机时期为4个**
   - 文件：spec.md:L81, tasks.md:L154
   - 行动：更新spec.md为"4个历史危机时期"

2. **明确市值数据源**
   - 文件：spec.md:FR-003
   - 行动：选择Wilshire 5000 (FRED)，删除Yahoo Finance

3. **修复文件命名**
   - 文件：plan.md:L92
   - 行动：统一使用data_fetcher.py

4. **添加监控机制任务**
   - 文件：tasks.md
   - 行动：在Phase 7添加每日/周/月/季度监控任务

### 🟡 建议改进 (HIGH)

5. **删除黄金/BTC需求**
   - 文件：spec.md:FR-003
   - 行动：删除未使用的功能或提供使用场景

6. **统一杠杆变化率定义**
   - 文件：spec.md:FR-006
   - 行动：基于Leverage_Net更新定义

7. **修复阶段编号**
   - 文件：tasks.md:L424
   - 行动：修正为"Phase 10个任务"

### 状态评估

- ✅ **可以继续实施**，但需要先解决4个CRITICAL问题
- ⚠️ **建议**在Phase 1开始前完成所有CRITICAL修复
- 📋 **优先级**：按A1-A4顺序依次修复

---

**分析完成**: 2025-11-12
**质量评级**: B+ (良好，需要修复关键问题)
**建议行动**: 修复CRITICAL问题后开始实施